name: Test attachmentAV Scan

on:
  push:
    branches:
      - main

permissions:
  actions: write
  contents: write

jobs:
  test_scans:
    name: Test local file, artifact, and release asset scanning
    runs-on: ubuntu-latest
    steps:
      # Checkout the repository to access files
      - name: Checkout
        uses: actions/checkout@v6

      # Test 1: Scan local file
      - name: Scan local .gitignore file
        id: scan_local
        uses: ./ # Uses the action in the root directory
        with:
          local-file-path: .gitignore
          api-key: ${{ secrets.ATTACHMENTAV_API_KEY }}
          fail-on-infected: true

      - name: Display local scan results
        run: |
          echo "Scan status: ${{ steps.scan_local.outputs.status }}"
          echo "File size: ${{ steps.scan_local.outputs.file-size }} bytes"
          echo "Real file type: ${{ steps.scan_local.outputs.real-file-type }}"
          if [ -n "${{ steps.scan_local.outputs.finding }}" ]; then
            echo "Finding: ${{ steps.scan_local.outputs.finding }}"
          fi

      # Test 2: Create and scan artifact
      - name: Upload action.yml as artifact
        id: upload_artifact
        uses: actions/upload-artifact@v6
        with:
          name: test-action-yml
          path: action.yml

      - name: Scan artifact
        id: scan_artifact
        uses: ./
        with:
          artifact-id: ${{ steps.upload_artifact.outputs.artifact-id }}
          api-key: ${{ secrets.ATTACHMENTAV_API_KEY }}
          token: ${{ github.token }}
          fail-on-infected: true

      - name: Display artifact scan results
        run: |
          echo "Scan status: ${{ steps.scan_artifact.outputs.status }}"
          echo "File size: ${{ steps.scan_artifact.outputs.file-size }} bytes"
          echo "Real file type: ${{ steps.scan_artifact.outputs.real-file-type }}"
          if [ -n "${{ steps.scan_artifact.outputs.finding }}" ]; then
            echo "Finding: ${{ steps.scan_artifact.outputs.finding }}"
          fi

      # Test 3: Create release and scan asset
      - name: Create release with action.yml asset
        id: create_release
        run: |
          # Create a test release with action.yml as an asset
          TAG_NAME="test-v${{ github.run_number }}"
          gh release create "$TAG_NAME" action.yml \
            --title "Test Release ${{ github.run_number }}" \
            --notes "Automated test release for attachmentAV scanning" \
            --repo ${{ github.repository }}

          # Get the asset ID
          ASSET_ID=$(gh api repos/${{ github.repository }}/releases/tags/$TAG_NAME \
            --jq '.assets[] | select(.name == "action.yml") | .id')
          echo "asset_id=$ASSET_ID" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Release created: $TAG_NAME"
          echo "Asset ID: $ASSET_ID"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Scan release asset
        id: scan_asset
        uses: ./
        with:
          release-asset-id: ${{ steps.create_release.outputs.asset_id }}
          api-key: ${{ secrets.ATTACHMENTAV_API_KEY }}
          token: ${{ github.token }}
          fail-on-infected: true

      - name: Display release asset scan results
        run: |
          echo "Scan status: ${{ steps.scan_asset.outputs.status }}"
          echo "File size: ${{ steps.scan_asset.outputs.file-size }} bytes"
          echo "Real file type: ${{ steps.scan_asset.outputs.real-file-type }}"
          if [ -n "${{ steps.scan_asset.outputs.finding }}" ]; then
            echo "Finding: ${{ steps.scan_asset.outputs.finding }}"
          fi

      # Test 4: Scan local file >10MB
      - name: Scan local random-80mb-file
        id: scan_local_80mb
        uses: ./ # Uses the action in the root directory
        with:
          local-file-path: test-data/random-80mb-file
          api-key: ${{ secrets.ATTACHMENTAV_API_KEY }}
          token: ${{ github.token }}
          fail-on-infected: true

      - name: Display large local file scan results
        run: |
          echo "Scan status: ${{ steps.scan_local_80mb.outputs.status }}"
          echo "File size: ${{ steps.scan_local.outputs_80mb.file-size }} bytes"
          echo "Real file type: ${{ steps.scan_local_80mb.outputs.real-file-type }}"
          if [ -n "${{ steps.scan_local_80mb.outputs.finding }}" ]; then
            echo "Finding: ${{ steps.scan_local_80mb.outputs.finding }}"
          fi

      # Test 5: Create and scan >200MB artifact
      - name: Duplicate test-data
        run: |
          cp test-data/random-80mb-file test-data/random-80mb-file2
          cp test-data/random-80mb-file test-data/random-80mb-file3
          cp test-data/random-80mb-file test-data/random-80mb-file4

      - name: Upload test-data/ folder as artifact
        id: upload_artifact_large
        uses: actions/upload-artifact@v6
        with:
          name: test-data-folder
          path: test-data/
          retention-days: 1 # set retention to avoid a full storage

      - name: Scan large artifact
        id: scan_artifact_large
        uses: ./
        with:
          artifact-id: ${{ steps.upload_artifact.outputs.artifact-id }}
          api-key: ${{ secrets.ATTACHMENTAV_API_KEY }}
          token: ${{ github.token }}
          fail-on-infected: true

      - name: Display large artifact scan results
        run: |
          echo "Scan status: ${{ steps.scan_artifact_large.outputs.status }}"
          echo "File size: ${{ steps.scan_artifact_large.outputs.file-size }} bytes"
          echo "Real file type: ${{ steps.scan_artifact_large.outputs.real-file-type }}"
          if [ -n "${{ steps.scan_artifact_large.outputs.finding }}" ]; then
            echo "Finding: ${{ steps.scan_artifact_large.outputs.finding }}"
          fi

      # Cleanup: Delete test release
      - name: Cleanup test release
        if: steps.create_release.outcome == 'success'
        run: |
          if [ -n "${{ steps.create_release.outputs.tag_name }}" ]; then
            gh release delete "${{ steps.create_release.outputs.tag_name }}" --yes --cleanup-tag || true
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Cleanup large artifact file
        if: steps.upload_artifact_large.outcome == 'success'
        run: |
          if [ -n "${{ steps.upload_artifact_large.outputs.artifact-id }}" ]; then
            curl -L \
              -X DELETE \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ github.token }}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              https://api.github.com/repos/${{ github.repository }}/actions/artifacts/${{ steps.upload_artifact_large.outputs.artifact-id }}
          fi
